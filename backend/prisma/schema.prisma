generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// *
///  * =========================
///  * USERS
///  * =========================
model User {
  id                   Int            @id @default(autoincrement())
  email                String         @unique
  password             String
  name                 String
  role                 UserRole
  active               Boolean        @default(true)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  identifier           String         @unique
  auditLogs            AuditLog[]
  notificationsCreated Notification[] @relation("NotificationCreator")
  quotes               Quote[]        @relation("UserQuotes")
}

model MatrixSection {
  id        Int            @id @default(autoincrement())
  key       String         @unique
  title     String
  type      String
  sortOrder Int            @default(0)
  active    Boolean        @default(true)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  choices   MatrixChoice[]
}

model MatrixChoice {
  id             Int              @id @default(autoincrement())
  sectionId      Int
  key            String           @unique
  label          String
  priceY1        Float            @default(0)
  priceY2        Float            @default(0)
  active         Boolean          @default(true)
  sortOrder      Int              @default(0)
  meta           Json?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  description    String?
  parentId       Int?
  allowQty       Boolean          @default(false)
  maxQty         Int?
  parent         MatrixChoice?    @relation("ChoiceHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children       MatrixChoice[]   @relation("ChoiceHierarchy")
  section        MatrixSection    @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  rulesAsDepends MatrixRule[]     @relation("rule_depends")
  rulesAsTarget  MatrixRule[]     @relation("rule_target")
  selections     QuoteSelection[]

  @@index([parentId])
}

model MatrixRule {
  id          Int          @id @default(autoincrement())
  type        String
  targetId    Int
  dependsOnId Int
  message     String?
  createdAt   DateTime     @default(now())
  dependsOn   MatrixChoice @relation("rule_depends", fields: [dependsOnId], references: [id], onDelete: Cascade)
  target      MatrixChoice @relation("rule_target", fields: [targetId], references: [id], onDelete: Cascade)

  @@index([targetId])
  @@index([dependsOnId])
}

model Quote {
  id            Int              @id @default(autoincrement())
  agentId       Int
  customerName  String
  customerEmail String
  totalY1       Float            @default(0)
  totalY2       Float            @default(0)
  emailContent  String
  status        QuoteStatus      @default(TO_SEND)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  customerPhone String?
  agent         User             @relation("UserQuotes", fields: [agentId], references: [id])
  selections    QuoteSelection[]
}

model QuoteSelection {
  id       Int          @id @default(autoincrement())
  quoteId  Int
  choiceId Int
  qty      Int          @default(1)
  choice   MatrixChoice @relation(fields: [choiceId], references: [id], onDelete: Cascade)
  quote    Quote        @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@unique([quoteId, choiceId])
  @@index([quoteId])
  @@index([choiceId])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  action    String
  tableName String
  recordId  Int?
  oldValue  String?
  newValue  String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model Notification {
  id        Int      @id @default(autoincrement())
  title     String
  message   String
  audience  String
  createdAt DateTime @default(now())
  createdBy Int?
  creator   User?    @relation("NotificationCreator", fields: [createdBy], references: [id])
}

model MatrixConfig {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

/// *
///  * =========================
///  * MATRIX ALERTS (alertes gérées par le Manager)
///  * - Conditions pour afficher des alertes à l'agent
///  * - Peut bloquer l'envoi si blocking = true
///  * =========================
model MatrixAlert {
  id              Int      @id @default(autoincrement())
  name            String
  message         String
  conditionType   String
  conditionConfig Json
  blocking        Boolean  @default(true)
  active          Boolean  @default(true)
  sortOrder       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum UserRole {
  ADMIN
  MANAGER
  AGENT
  FORMATION
  BACKOFFICE
}

enum QuoteStatus {
  DRAFT
  TO_SEND
  MAIL_SENT
  NEED_FIX
  REJECTED
}
